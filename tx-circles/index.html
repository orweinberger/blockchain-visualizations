<!DOCTYPE html>
<meta charset="utf-8">
<style>

  text {
    font: bold 48px monospace;
  }
  circle {
    cursor: pointer;
    opacity:0.8;
  }

</style>
<body>

<script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
<script src="http://d3js.org/d3.v2.min.js?2.10.1"></script>
<script src="https://insight.bitpay.com/socket.io/socket.io.js"></script>

<script>

  function getRandomColor() {
    var letters = '0123456789ABCDEF'.split('');
    var color = '#';
    for (var i = 0; i < 6; i++) {
      color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
  }
  var width = $(document).width()-50,
    height = $(document).height()-50;
  var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

  function getTxData(txid, cb) {
    $.get("https://insight.bitpay.com/api/tx/" + txid, function (data) {
      return cb(data);
    });
  }

  function appendCircle(txid) {
    var minR = 40;
    var maxR = 200;
    getTxData(txid, function (data) {
      var radius;
      if (data.valueOut < minR)
        radius = minR;
      else if (data.valueOut > minR && data.valueOut < maxR)
        radius = data.valueOut;
      else
        radius = maxR;

      var cx = Math.floor(Math.random() * ((width - radius) - radius + 1) + radius);
      var cy = Math.floor(Math.random() * ((height - radius) - radius + 1) + radius);
      var g = svg.append("g");
      var circle = g.append("circle");
      circle
        .style("fill", getRandomColor())
        .attr("r", radius)
        .attr("cx", cx)
        .attr("cy", cy)
        .on('click', function() {
          window.location = 'https://insight.bitpay.com/tx/' + txid;
        });
      var txidtext = g.append("text");
      txidtext
        .attr("x", cx - 34)
        .attr("y", cy + 2)

        .attr("font-family", "sans-serif")
        .style("font-size", "14px")
        .text(txid.substring(0, 8))
        .on('click', function() {
          window.location = 'https://insight.bitpay.com/tx/' + txid;
        });

      var valuetext = g.append("text");
      valuetext
        .attr("x", cx - 26)
        .attr("y", cy + 22)
        .attr("font-family", "sans-serif")
        .style("font-size", "14px")
        .text(data.valueOut.toString().substring(0, 6))
        .on('click', function() {
          window.location = 'https://insight.bitpay.com/tx/' + txid;
        });
      setTimeout(function () {
        g.remove();
      }, 5000);
    });
  }


</script>

<script>
  eventToListenTo = 'tx';
  room = 'inv';
  console.log('loaded', io);
  var socket = io("https://insight.bitpay.com:443/");
  socket.on('connect', function () {
    console.log('connected');
    socket.emit('subscribe', room);
  });
  socket.on(eventToListenTo, function (data) {
    appendCircle(data.txid);
  })
</script>